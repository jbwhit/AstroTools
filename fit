#!/bin/bash
# Copyright Jonathan Whitmore
# Distributed under the Boost Software License, Version 1.0.
#
# Permission is hereby granted, free of charge, to any person or organization
# obtaining a copy of the software and accompanying documentation covered by
# this license (the "Software") to use, reproduce, display, distribute,
# execute, and transmit the Software, and to prepare derivative works of the
# Software, and to permit third-parties to whom the Software is furnished to
# do so, all subject to the following:
#
# The copyright notices in the Software and this entire statement, including
# the above license grant, this restriction and the following disclaimer,
# must be included in all copies of the Software, in whole or in part, and
# all derivative works of the Software, unless such copies or derivative
# works are solely in the form of machine-executable object code generated
# by a source language processor.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND
# NON-INFRINGEMENT. IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR ANYONE
# DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY,
# WHETHER IN CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
# 

## ARGV flags and their explanations
## -- 1 fort.13 filename
## -- 2 fitting level (level 4 is the best fitting level; level 1 is the fastest)
## -- 3 which data to use: blind or unblind.
##

if [ "$1" == "--help" ]; then
  echo "ex: fit fort.13 --l2"
  exit
fi

TIMESTAMP=$(date +%Y.%m.%d.%H.%M.%S)
export VPFSETUP=/nfs/cluster/qso/jwhitmore/fits/setup/vp_setup.dat
export ATOMDIR=/nfs/cluster/qso/jwhitmore/fits/setup/MM_VPFIT_2012-06-05_noiso.dat
export VPFPLOTS=/nfs/cluster/qso/jwhitmore/fits/setup/vp_splot.dat

if [ "$3" == "--unblind" ]; then
  echo "Using the unblinded data."
  export DATAFILE=/nfs/cluster/qso/jwhitmore/fits/UVES/185.A-0745/J222006-280323/unblinded/he2217m2818.fits
elif [ "$2" == "--P169" ]; then
  export DATAFILE=/nfs/cluster/qso/jwhitmore/fits/UVES/185.A-0745/J222006-280323/paoloandmiriam/norAq2217.dat
elif [ "$2" == "--P162" ]; then
  export DATAFILE=/nfs/cluster/qso/jwhitmore/fits/UVES/185.A-0745/J222006-280323/paoloandmiriam/norBq2217.dat
elif [ "$2" == "--P155" ]; then
  export DATAFILE=/nfs/cluster/qso/jwhitmore/fits/UVES/185.A-0745/J222006-280323/paoloandmiriam/norCq2217.dat
else
  echo "Using the BLIND data."
  export DATAFILE=/nfs/cluster/qso/jwhitmore/fits/UVES/185.A-0745/J222006-280323/J222006-280323.fits
fi

echo "Here's your chance to stop things before we get going... "
sleep 2

# consider running the fit in a screen session named after the TIMESTAMP (so screen -r $TIMESTAMP) brings that about
# then immediately dropping into a "comment.txt" in the fitting directory so that comments to that run can be added.
# Would have to be sure that the screen program inherited all of the proper environment variables, etc.

mkdir $TIMESTAMP
cd $TIMESTAMP

ln -s $DATAFILE .

cp ../$1 fort.13
# Split file into file header and model portions.
# csplit -s [suppress bytesize output] filename '%throw away until this expression%' '/split file at this expression/'
csplit -s fort.13 '%^   \*%' '/^  \*/1'
# This outputs two files: xx00, xx01
mv xx00 head.13
mv xx01 body.13

cat head.13 body.13 > fort.13 # This overwrites fort.13 -- this is good.

if [ "$2" == "--fine" ]; then
  echo "Wrong choice"
  exit
elif [ "$2" == "--paolo" ]; then
  FITTINGPARAMETERS="f\nil\ncs\n5.e-7 50.0 5.e-7\nn\n0.003\nb\n0.02\nz\n1.e-6\nx4\n5.e-7\n\n\nfort.13\nn\nn\n\n"
  echo "paolo" >> fit.log
elif [ "$2" == "--l1" ]; then
  FITTINGPARAMETERS="f\nil\ncs\n2.e-4 100.0 2.e-4\nn\n0.01 \nb\n0.2 \nz\n2.e-6\nx4\n5.e-6\n\n\nfort.13\nn\nn\n\n"
  echo "l1" >> fit.log
elif [ "$2" == "--l2" ]; then
  FITTINGPARAMETERS="f\nil\ncs\n2.e-5 100.0 2.e-5\nn\n0.005\nb\n0.1 \nz\n2.e-7\nx4\n5.e-6\n\n\nfort.13\nn\nn\n\n"
  echo "l2" >> fit.log
elif [ "$2" == "--l3" ]; then
  FITTINGPARAMETERS="f\nil\ncs\n2.e-6 100.0 2.e-6\nn\n0.002\nb\n0.05\nz\n2.e-7\nx4\n5.e-7\n\n\nfort.13\nn\nn\n\n"
  echo "l3" >> fit.log
elif [ "$2" == "--l4" ]; then
  FITTINGPARAMETERS="f\nil\ncs\n2.e-7 100.0 2.e-7\nn\n0.002\nb\n0.05\nz\n2.e-7\nx4\n5.e-7\n\n\nfort.13\nn\nn\n\n"
  echo "l4" >> fit.log
else
  echo "You must specify a step-size level (--l[1-4]) with level 4 being the finest fit."
fi

# TODO copy exact setup and atom.dat files to fitting directory.

echo "! Setup file used:    $VPFSETUP" > fit.command
echo "! atom.dat file used: $ATOMDIR" >> fit.command
echo "! Fitting parameters: $FITTINGPARAMETERS" >> fit.command

cat fit.command fort.13 > temp.13 && mv temp.13 fort.13

# TODO include vpfit version in log file.

printf "$FITTINGPARAMETERS" | /home/ssi/jwhitmore/bin/vpfit10 

cat fit.command fort.26 > temp.26 && mv temp.26 fort.26

combine2613 fort.13 fort.26 temp.fit

cat fit.command temp.fit > temp && mv temp fit.13 
rm temp.fit

grep 'BAD' fort.26 
grep 'dropped' fort.18 
echo $TIMESTAMP

# echo "iter;  chisq;    Npix;   DoF; Ndropped; Filename; level; alpha-fit"
awk '/Stat/{printf("%3i  %3.7f %6i %6i %6i     %s \n"), $3, $4, $5, $6, $8, "'$TIMESTAMP'" "/" FILENAME}' fit.13 | paste - fit.log > temp
awk '/qa/{print "alpha"}' fit.13 | paste temp - > summary.txt

cp fit.13 ..
cd ..

# Create pdf of full plot and individual plots.

# TODO find some way to parse things that won't change (fit results, time, date) plus things
# that might change (comment on run, comment on something strange).